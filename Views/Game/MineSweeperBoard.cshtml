@model MinesweeperWebApp.Models.GameLogic.Board

@{
    ViewData["Title"] = "Minesweeper Board";
}

<h2 class="text-center mt-4">Minesweeper</h2>

@if (TempData["SaveMessage"] != null)
{
    <div class="alert alert-success text-center">
        @TempData["SaveMessage"]
    </div>
}


<!-- Timestamp updates automatically with AJAX -->
<div id="timestamp-area" class="text-center mb-3"></div>

<!-- Save Game button -->
<form asp-action="SaveGame" method="post" class="text-center mb-3">
    <button type="submit" class="btn btn-primary">Save Game</button>
</form>


<div class="d-flex justify-content-center">

    <div class="halo-container">

        <!-- AJAX will replace only this DIV when a cell updates -->
        <div id="board-container">

            <table class="table table-bordered ms-board" style="width:auto;">
                <tbody>
                    @for (int row = 0; row < Model.Size; row++)
                    {
                        <tr>
                            @for (int col = 0; col < Model.Size; col++)
                            {
                                @await Html.PartialAsync("_CellPartial", Model.Grid[row][col])
                            }
                        </tr>
                    }
                </tbody>
            </table>

        </div> <!-- END board-container -->

    </div> <!-- END halo-container -->

</div>

<form asp-action="SavedGames" method="get" class="text-center mb-3">
    <button type="submit" class="btn btn-secondary">Show Saved Games</button>
</form>


@section Scripts {

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        // ----------------------------------------------------------
        // LEFT CLICK — normal cell reveal
        // ----------------------------------------------------------
               $(document).on("click", ".tile-btn", function (e) {
            e.preventDefault();

            let row = $(this).data("row");
            let col = $(this).data("col");

            // Prevent opening flagged tiles
            if ($(this).hasClass("tile-flag"))
                return;

            $.ajax({
                url: "/Game/CellClickAjax",
                type: "POST",
                data: { row: row, col: col },
                success: function (result) {

                    // WIN / LOSS redirect logic
                    if (result.redirect) {
                        window.location = result.redirect;
                        return;
                    }

                    // Update board normally
                    $("#board-container").html(result);
                    updateTimestamp();
                }
            });
        });

        // ----------------------------------------------------------
        // RIGHT CLICK — toggle flag
        // ----------------------------------------------------------
        $(document).on("contextmenu", ".tile-btn", function (e) {
            e.preventDefault();

            let row = $(this).data("row");
            let col = $(this).data("col");

            $.ajax({
                url: "/Game/ToggleFlagAjax",
                type: "POST",
                data: { row: row, col: col },
                success: function (html) {
                    $("#board-container").html(html);
                    updateTimestamp();
                }
            });
        });

        // ----------------------------------------------------------
        // TIMESTAMP — updated every click via AJAX
        // ----------------------------------------------------------
        function updateTimestamp() {
            $.ajax({
                url: "/Game/Timestamp",
                success: function (data) {
                    $("#timestamp-area").html(data);
                }
            });
        }

        // Load timestamp when page loads
        updateTimestamp();
    </script>

}
